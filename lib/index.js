var t=function(){return t=Object.assign||function(t){for(var n,e=1,o=arguments.length;e<o;e++)for(var r in n=arguments[e])Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r]);return t},t.apply(this,arguments)};function n(t,n,e){return function(){for(var o=[],r=0;r<arguments.length;r++)o[r]=arguments[r];t[n]=e.apply(void 0,function(t,n,e){if(e||2===arguments.length)for(var o,r=0,a=n.length;r<a;r++)!o&&r in n||(o||(o=Array.prototype.slice.call(n,0,r)),o[r]=n[r]);return t.concat(o||Array.prototype.slice.call(n))}([t[n]],o,!1))}}var e={concat:!0,delay:2e3,maxError:16,sampling:1},o=t(t({},{url:"http://www.nebulanimble.site:8000/api/log"}),{pid:void 0,is_test:!1,getPageType:function(t){return void 0===t&&(t=window.location),"".concat(t.host).concat(t.pathname)}});var r,a={mergeConfig:function(n){o=t(t({},o),n)},getConfig:function(){return o}},c=e.maxError,i=e.sampling,s=e.concat,u=[];function f(t){var n,o,a,c;!function(t,n){for(var e in t)n[e]=t[e]}(t,e),n=e.report,o=e.delay,a=function(){u=[]},r=function(){var t=this,e=arguments;clearTimeout(c),c=setTimeout((function(){n.apply(t,e),!a||a()}),o)}}function p(t){s?(!function(t){d(i)&&u.length<c&&u.push(t)}(t),r(u)):!d(i)||e.report([t])}function d(t){return Math.random()<(t||1)}var l,h=1,_=9,g=10;!function(t){t[t.SCRIPT=2]="SCRIPT",t[t.LINK=3]="LINK",t[t.IMG=4]="IMG",t[t.AUDIO=5]="AUDIO",t[t.VIDEO=6]="VIDEO"}(l||(l={}));var v={1:"JS_RUNTIME_ERROR",2:"SCRIPT_LOAD_ERROR",3:"CSS_LOAD_ERROR",4:"IMAGE_LOAD_ERROR",5:"AUDIO_LOAD_ERROR",6:"VIDEO_LOAD_ERROR",7:"CONSOLE_ERROR",8:"TRY_CATCH_ERROR",9:"ERROR_FETCH",10:"ERROR_XHR"};function m(t){return{type:_,payload:t}}var y=[];y[1]={df:["url","http_code","during_ms","size"],ef:["params","response"],dft:{size:"response_size_b"}},y[2]={df:["url"],ef:["params","response"],dft:{}},y[3]={df:["url","reason"],ef:["code"],dft:{reason:"error_no"}},y[4]={df:["step"],ef:["desc"],dft:{step:"error_no"}},y[5]={df:["url","step"],ef:["params"],dft:{step:"error_no"}},y[8]={df:[],dft:{error_name:"error_no",http_code:"http_code",during_ms:"during_ms",url:"url",request_size_b:"request_size_b",response_size_b:"response_size_b"}};var R=function(n,e,o,r){void 0===n&&(n=""),void 0===o&&(o={}),void 0===r&&(r={});var c=a.getConfig(),i=c.getPageType,s=window.location,u=s.href;try{u=""+i(s)}catch(t){w("config.getPageType执行时发生异常, 请注意, 错误信息=>",{e:t,location:s}),u="".concat(s.host).concat(s.pathname)}var f,p={type:n,code:e,detail:o,extra:r,common:t(t({},c),{timestamp:Date.now(),page_type:u})};"error"===n?f="/monitor":"perf"===n&&(f="/perf");try{(new Image).src="".concat(c.url+f,"?d=").concat(encodeURIComponent(JSON.stringify(p)))}catch(t){console.log(t)}};function w(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];a.getConfig().is_test&&console.info.apply(console,t)}R.product=function(t,n,e){R("product",t,n,e)};var E=function(n,e){void 0===e&&(e={});var o=y[n];if(o){var r=t({},{error_no:"",http_code:"",during_ms:"",url:"",request_size_b:"",response_size_b:""});return Object.keys(e).forEach((function(t){var n=o.dft[t];n?(r[n]=e[t],delete e[t]):r[t]=e[t]})),r}return e};var O={concat:!0,report:function(n){void 0===n&&(n=[]);for(var e=0,o=n;e<o.length;e++){var r=o[e],a=r.type,c=r.desc,i=r.stack,s=r.payload,u=v[a],f=window.location;w("[自动]捕捉到页面错误, 发送打点数据, 上报内容 => ",{error_no:u,url:"".concat(f.host).concat(f.pathname),desc:c,stack:i}),a===_||a===g?R("error",1,t(t({},s||{}),{error_no:u,url:"".concat(f.host).concat(f.pathname)})):5===a||4===a||2===a||3===a?R("error",2,E(a,{error_no:u,url:"".concat(f.host).concat(f.pathname)}),{desc:c,stack:i}):R("error",3,{error_no:u,url:"".concat(f.host).concat(f.pathname)},{desc:c,stack:i})}}};function I(){return{start:function(){f(O),window.addEventListener("error",(function(t){t.error&&p(function(t,n,e,o,r){return{type:h,desc:t+" at "+n+":"+e+":"+o,stack:r&&r.stack?r.stack:"no stack"}}(t.message,t.filename,t.lineno,t.colno,t.error))})),window.addEventListener("unhandledrejection",(function(t){p({type:h,desc:t.reason,stack:"no stack"})})),window.addEventListener("error",(function(t){console.log("resource error");var n,e=t.target||t.srcElement;if(!(e instanceof HTMLElement))return!1;p({type:l[(n=e).nodeName.toUpperCase()],desc:n.baseURI+"@"+(n.src||n.href),stack:"no stack"})}),!0),n(XMLHttpRequest.prototype,"open",(function(t){return function(n,e){this.payload={method:n,url:e},t.apply(this,[n,e])}}))(),n(XMLHttpRequest.prototype,"send",(function(t){return function(){for(var n=this,e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];this.addEventListener("readystatechange",(function(){var t;n.payload.status=n.status,p((t=n.payload,{type:g,payload:t}))})),t.apply(this,e)}}))(),n(window,"fetch",(function(t){return function(n,e){var o="string"==typeof n?n:n.url||"Unknown URL",r={method:e&&e.method||"GET",url:o,headers:e&&e.headers||{},body:e&&e.body||""};return t.apply(this,[n,e]).then((function(t){return t.ok||(r.status=t.status,r.statusText=t.statusText,p(m(r))),t})).catch((function(t){throw r.status=0,r.statusText=t.message,p(m(r)),t}))}}))()}}}var T=9e5,b=5e3,L=Date.now();var k=new function(n){var e=[I()];this.init=function(o){n.mergeConfig(o);var r=n.getConfig();r.pid?(console.log(r),r.enablePerformance&&e.push({start:function(){var n=window.performance;if(n){var e=n.getEntriesByType("navigation")[0].toJSON();w("发送页面性能指标数据, 上报内容 => ",t(t({},e),{url:"".concat(window.location.host).concat(window.location.pathname)})),R("perf",4,t(t({},e),{url:"".concat(window.location.host).concat(window.location.pathname)}))}else console.log("你的浏览器不支持 performance 接口")}}),r.enableBehavior&&e.push({start:function(){window.addEventListener("click",(function(){var t=Date.now()-L;t>T?L=Date.now():t>b&&(L=Date.now(),w("发送用户留存时间埋点, 埋点内容 => ",{duration_ms:t}),R.product(10001,{duration_ms:t}))}))}}),e.forEach((function(t){return t.start()}))):console.log("请输入必要的配置pid")}}(a);export{k as default};
